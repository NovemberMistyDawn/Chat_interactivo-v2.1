<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Interactivo</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="welcome">
        <h1>Bienvenido al Chat</h1>
        <input type="text" id="username" placeholder="Ingresa tu nombre" />
        <button id="joinChat">Unirse al chat</button>
    </div>

    <div id="chat" style="display:none;">
        <button id="toggleUsersButton">Ocultar Usuarios</button> <!-- BotÃ³n para mostrar/ocultar usuarios -->
        <h3>Usuarios conectados:</h3>
        <div id="users"></div>
        <div id="messages" class="messages"></div>
        <div class="message-input-container">
        <input type="text" id="messageInput" placeholder="Escribe un mensaje" />
        <button  id="sendButton" onclick="sendMessage()">Enviar</button> 
        <div class="format-options">
            <button id="emojiButton" onclick="toggleEmojiPicker()">ğŸ˜Š</button>
        </div>
        <button id="uploadButton" onclick="document.getElementById('fileInput').click();">ğŸ“· Subir Imagen</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="uploadImage(event)" />
    </div>
    </div>

    <div id="emojiPicker" style="display:none;" class="emoji-picker">
        <span onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</span>
        <span onclick="addEmoji('ğŸ˜‚')">ğŸ˜‚</span>
        <span onclick="addEmoji('ğŸ˜¢')">ğŸ˜¢</span>
        <span onclick="addEmoji('â¤ï¸')">â¤ï¸</span>
        <span onclick="addEmoji('ğŸ‘')">ğŸ‘</span>
        <span onclick="addEmoji('ğŸ‰')">ğŸ‰</span>
        <span onclick="addEmoji('ğŸ˜')">ğŸ˜</span>
        <span onclick="addEmoji('ğŸ˜œ')">ğŸ˜œ</span>
        <!-- Agrega mÃ¡s emojis segÃºn sea necesario -->
    </div>

    <div id="privateChatContainer"></div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "API_KEY",
            authDomain: "chat-interactivo-ce323.firebaseapp.com",
            databaseURL: "https://chat-interactivo-ce323-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "chat-interactivo-ce323",
            storageBucket: "chat-interactivo-ce323.appspot.com",
            messagingSenderId: "474997098356",
            appId: "1:474997098356:web:86ed5449562419fa964e21",
            measurementId: "G-FRE2732VJC"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const usersRef = db.collection('users');
        const messagesRef = db.collection('mensajes');
        let userId = null; 
        let userName = null;

        document.getElementById('joinChat').addEventListener('click', () => {
            userName = document.getElementById('username').value.trim();
            if (userName) {
                usersRef.add({
                    name: userName,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then((docRef) => {
                    userId = docRef.id;
                    document.getElementById('welcome').style.display = 'none';
                    document.getElementById('chat').style.display = 'block';
                    loadUsers(); 
                    loadMessages();
                }).catch((error) => {
                    console.error("Error al guardar el usuario: ", error);
                });
            } else {
                alert('Por favor, ingresa un nombre.');
            }
        });

        function loadUsers() {
            usersRef.onSnapshot((snapshot) => {
                const usersContainer = document.getElementById('users');
                usersContainer.innerHTML = ''; 
                snapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (doc.id !== userId) { 
                        const userButton = document.createElement('button');
                        userButton.textContent = userData.name;
                        userButton.onclick = () => openPrivateChat(userData.name);
                        usersContainer.appendChild(userButton);
                    }
                });
            });
        }

        
        function loadMessages() {
    messagesRef.orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = ''; 
        snapshot.forEach((doc) => {
            const messageData = doc.data();
            const messageElement = document.createElement('div');

            // Verificar si el mensaje fue enviado por el usuario actual
            if (messageData.userId === userId) {
                messageElement.classList.add('message', 'sent');
            } else {
                messageElement.classList.add('message', 'received');
            }

            // Comprobar si hay una imagen
            if (messageData.imageUrl) {
                const imgElement = document.createElement('img');
                imgElement.src = messageData.imageUrl;
                imgElement.alt = "Imagen enviada";
                imgElement.style.maxWidth = "100%"; // Ajustar el tamaÃ±o de la imagen
                imgElement.style.borderRadius = "20px"; // AÃ±adir bordes redondeados
                messageElement.appendChild(imgElement);
            } else {
                messageElement.textContent = `${messageData.sender}: ${messageData.message}`;
            }

            messagesContainer.appendChild(messageElement);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
}




        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message && userId) {
                messagesRef.add({
                    message: message,
                    sender: userName,
                    userId: userId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = '';
            }
        }




        function uploadImage(event) {
    const file = event.target.files[0];
    if (file) {
        const storageRef = firebase.storage().ref();
        const fileRef = storageRef.child(`images/${file.name}`);
        
        fileRef.put(file).then(() => {
            // Obtener la URL de descarga de la imagen
            fileRef.getDownloadURL().then((url) => {
                sendMessageWithImage(url);
            });
        }).catch((error) => {
            console.error("Error al subir la imagen: ", error);
        });
    }
}

function sendMessageWithImage(imageUrl) {
    if (userId) {
        messagesRef.add({
            imageUrl: imageUrl,
            sender: userName,
            userId: userId,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
}

        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
        }

        function addEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji; 
            toggleEmojiPicker(); 
        }

        function openPrivateChat(recipient) {
            const chatId = `privateChat_${recipient}`;
            let chatWindow = document.getElementById(chatId);

            if (!chatWindow) {
                chatWindow = document.createElement('div');
                chatWindow.id = chatId;
                chatWindow.className = 'private-chat';
                chatWindow.innerHTML = `
                    <strong>Chat con ${recipient}</strong>
                    <div class="private-messages" id="${chatId}_messages"></div>
                    <input type="text" class="private-input" id="${chatId}_input" placeholder="Escribe un mensaje" />
                    <button onclick="sendPrivateMessage('${recipient}')">Enviar</button>
                `;
                document.getElementById('privateChatContainer').appendChild(chatWindow);

                document.getElementById(`${chatId}_input`).addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        sendPrivateMessage(recipient);
                    }
                });
            }

            chatWindow.style.display = 'block';
            document.getElementById(`${chatId}_input`).focus();
        }

        function sendPrivateMessage(recipient) {
            const chatId = `privateChat_${recipient}`;
            const messageInput = document.getElementById(`${chatId}_input`);
            const message = messageInput.value.trim();
            if (message) {
                const privateMessagesContainer = document.getElementById(`${chatId}_messages`);
                const messageElement = document.createElement('div');
                messageElement.textContent = `${userName} (a ${recipient}): ${message}`;
                privateMessagesContainer.appendChild(messageElement);
                messageInput.value = '';
                messageInput.focus();
            }
        }

        // LÃ³gica para alternar la visibilidad de la lista de usuarios
        document.getElementById('toggleUsersButton').addEventListener('click', () => {
            const usersContainer = document.getElementById('users');
            if (usersContainer.style.display === 'none') {
                usersContainer.style.display = 'block';
                document.getElementById('toggleUsersButton').textContent = 'Ocultar Usuarios';
            } else {
                usersContainer.style.display = 'none';
                document.getElementById('toggleUsersButton').textContent = 'Mostrar Usuarios';
            }
        });
    </script>
</body>
</html>